generator client {
  provider = "prisma-client-js"
  //output   = "../src/generated/client"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ===== User =====
model User {
  id               String   @id @default(cuid())
  email            String?  @unique
  name             String
  role             UserRole @default(CONSUMER)
  kakaoSub         String?  @unique
  referrerCodeUsed String?
  approve          Boolean  @default(false)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  phoneNumber       String?
  shippingAddress   Json?
  talkMessageAgreed Boolean @default(false)

  // Relations
  seller       Seller?
  orders       Order[]
  cart         Cart?
  reviews      Review[]
  qnas         Qna[]
  pointsLedger PointsLedger[]
  userCoupons  UserCoupon[]
  auditLogs    AuditLog[]
  wishlist     Wishlist[]
  payments     Payment[]
  addresses    UserAddress[]
  referralCode ReferralCode?  @relation(fields: [referrerCodeUsed], references: [code])

  @@index([referrerCodeUsed]) // ğŸ’¡ ì¡°íšŒ ìµœì í™”
  @@index([phoneNumber])
  @@map("users")
}

model Seller {
  id                 String   @id @default(cuid())
  userId             String   @unique
  companyName        String
  representativeName String
  phone              String   @unique
  address            String
  isVerified         Boolean  @default(false)
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  referralCodes ReferralCode[]

  @@map("sellers")
}

model ReferralCode {
  id          String   @id @default(cuid())
  code        String   @unique
  currentUses Int      @default(0)
  isActive    Boolean  @default(true)
  sellerId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  seller Seller? @relation(fields: [sellerId], references: [id])
  users  User[]

  @@map("referral_codes")
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  parentId    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@map("categories")
}

model Vendor {
  id         String  @id @default(cuid())
  name       String
  code       String  @unique // KLJ, HOYD ë“± ì§§ì€ ì‹ë³„ì
  isActive   Boolean @default(true)
  cutoffTime String? // "16:00" ë“± ë°œì£¼ ë§ˆê°ì‹œê°„
  notes      Json? // ì—‘ì…€ í…œí”Œë¦¿, ì—´ ë§¤í•‘, íŠ¹ì´ì‚¬í•­ ë“±

  // Relations
  products Product[] // 1 : N (Vendor â†’ Products)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vendors")
}

// ===== Product =====
model Product {
  id                String   @id @default(cuid())
  name              String
  description       String
  shortDescription  String?
  priceB2B          Decimal  @db.Decimal(12, 2) // â† Float -> Decimal
  priceB2C          Decimal  @db.Decimal(12, 2) // â† Float -> Decimal
  comparePrice      Decimal? @db.Decimal(12, 2)
  sku               String   @unique @default(uuid())
  weight            Decimal? @db.Decimal(10, 3) // ğŸ’¡ í•„ìš”ì‹œ ì •ë°€ë„ ì¡°ì •
  length            Decimal? @db.Decimal(10, 2)
  width             Decimal? @db.Decimal(10, 2)
  height            Decimal? @db.Decimal(10, 2)
  images            Json // â† String[] -> Json (MySQL ë¦¬ìŠ¤íŠ¸ ë¯¸ì§€ì›)
  categoryId        String
  vendorId          String?
  isActive          Boolean  @default(true)
  isFeatured        Boolean  @default(false)
  stockQuantity     Int      @default(0)
  lowStockThreshold Int?
  tags              Json // â† String[] -> Json
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  descriptionImages Json?

  // Relations
  category   Category    @relation(fields: [categoryId], references: [id])
  vendor     Vendor?     @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  cartItems  CartItem[]
  orderItems OrderItem[]
  reviews    Review[]
  qnas       Qna[]
  wishlist   Wishlist[]

  @@index([categoryId])
  @@index([vendorId])
  @@index([isActive, isFeatured])
  @@map("products")
}

// ===== Wishlist =====
model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId]) // í•œ ì‚¬ìš©ìê°€ ê°™ì€ ìƒí’ˆì„ ì¤‘ë³µ ì°œí•  ìˆ˜ ì—†ìŒ
  @@index([userId])
  @@index([productId])
  @@map("wishlist")
}

// ===== Coupon / Payment ë“± ê¸ˆì•¡ í•„ë“œ Decimalë¡œ í†µì¼ =====
model Coupon {
  id            String       @id @default(cuid())
  code          String       @unique
  name          String
  description   String?
  discountType  DiscountType
  discountValue Decimal      @db.Decimal(12, 2) // í• ì¸ìœ¨(%) ë˜ëŠ” í• ì¸ê¸ˆì•¡(ì›)
  minAmount     Decimal?     @db.Decimal(12, 2) // ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡
  maxAmount     Decimal?     @db.Decimal(12, 2) // ìµœëŒ€ í• ì¸ ê¸ˆì•¡
  maxUses       Int? // ì´ ì‚¬ìš© ê°€ëŠ¥ íšŸìˆ˜
  currentUses   Int          @default(0) // í˜„ì¬ ì‚¬ìš©ëœ íšŸìˆ˜
  userMaxUses   Int? // ì‚¬ìš©ìë‹¹ ì‚¬ìš© ê°€ëŠ¥ íšŸìˆ˜
  startsAt      DateTime? // ì‚¬ìš© ì‹œì‘ì¼
  endsAt        DateTime? // ì‚¬ìš© ì¢…ë£Œì¼
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  orders      Order[]
  userCoupons UserCoupon[]

  @@index([isActive, endsAt]) // ğŸ’¡ ë§Œë£Œ/ë…¸ì¶œ ì¡°íšŒìš©
  @@map("coupons")
}

model UserCoupon {
  id         String    @id @default(cuid())
  userId     String
  couponId   String
  usageCount Int       @default(0) // í•´ë‹¹ ì‚¬ìš©ìì˜ ì´ ì¿ í° ì‚¬ìš© íšŸìˆ˜
  deletedAt  DateTime? // ì†Œí”„íŠ¸ ë”œë¦¬íŠ¸ë¥¼ ìœ„í•œ í•„ë“œ
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@unique([userId, couponId])
  @@map("user_coupons")
}

model PointsLedger {
  id          String     @id @default(cuid())
  userId      String
  type        PointsType
  amount      Int
  balance     Int
  description String
  metadata    Json?
  createdAt   DateTime   @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("points_ledger")
}

model Cart {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  quantity  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
  @@map("cart_items")
}

model Order {
  id               String      @id @default(cuid())
  orderNumber      String      @unique
  userId           String
  couponId         String?
  status           OrderStatus @default(PENDING)
  subtotal         Decimal     @db.Decimal(12, 2)
  discountAmount   Decimal     @default(0) @db.Decimal(12, 2)
  shippingAmount   Decimal     @default(0) @db.Decimal(12, 2)
  taxAmount        Decimal     @default(0) @db.Decimal(12, 2)
  totalAmount      Decimal     @db.Decimal(12, 2)
  referralCodeUsed String?
  couponCodeUsed   String?
  shippingAddress  Json
  billingAddress   Json
  notes            String?
  metadata         Json?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  user      User        @relation(fields: [userId], references: [id])
  coupon    Coupon?     @relation(fields: [couponId], references: [id])
  items     OrderItem[]
  shipments Shipment[]
  returns   Return[]
  refunds   Refund[]
  reviews   Review[]
  auditLogs AuditLog[]

  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@map("orders")
}

model OrderItem {
  id             String   @id @default(cuid())
  orderId        String
  productId      String
  productName    String
  productSku     String
  quantity       Int
  unitPrice      Decimal  @db.Decimal(12, 2)
  totalPrice     Decimal  @db.Decimal(12, 2)
  discountAmount Decimal  @default(0) @db.Decimal(12, 2)
  finalPrice     Decimal  @db.Decimal(12, 2)
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  allocations ShipmentAllocation[] @relation("OrderItemToAlloc")
  returns     Return[]
  refunds     Refund[]
  reviews     Review[]

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Payment {
  id                  String        @id @default(cuid())
  orderId             String        @unique // ì£¼ë¬¸ ID (í† ìŠ¤í˜ì´ë¨¼ì¸ ìš©)
  orderName           String // ì£¼ë¬¸ëª…
  paymentKey          String?       @unique // í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ í‚¤
  paymentNumber       String?       @unique // ê²°ì œ ë²ˆí˜¸ (ë‚´ë¶€ìš©)
  amount              Int // ê²°ì œ ê¸ˆì•¡ (ì •ìˆ˜)
  currency            String        @default("KRW")
  method              String? // ê²°ì œ ìˆ˜ë‹¨ (ì¹´ë“œ, ê³„ì¢Œì´ì²´ ë“±)
  status              PaymentStatus @default(PENDING)
  customerKey         String // êµ¬ë§¤ì ì‹ë³„í‚¤
  customerId          String // êµ¬ë§¤ì ID
  customerEmail       String? // êµ¬ë§¤ì ì´ë©”ì¼
  customerName        String? // êµ¬ë§¤ì ì´ë¦„
  customerMobilePhone String? // êµ¬ë§¤ì íœ´ëŒ€í°ë²ˆí˜¸
  idempotencyKey      String?       @unique
  pgTransactionId     String? // PG ê±°ë˜ ID
  pgResponse          Json? // PG ì‘ë‹µ ë°ì´í„°
  failureReason       String? // ì‹¤íŒ¨ ì‚¬ìœ 
  approvedAt          DateTime? // ìŠ¹ì¸ ì‹œê°„
  metadata            Json? // ì¶”ê°€ ë©”íƒ€ë°ì´í„°
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  user      User       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  auditLogs AuditLog[]

  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model Shipment {
  id             String         @id @default(cuid())
  orderId        String
  trackingNumber String         @unique
  carrier        String
  status         ShipmentStatus @default(PENDING)
  shippedAt      DateTime?
  deliveredAt    DateTime?
  metadata       Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade, map: "fk_shipments__order")

  allocations ShipmentAllocation[] @relation("ShipmentToAlloc")

  @@index([carrier])
  @@map("shipments")
}

model ShipmentAllocation {
  id          String @id @default(cuid())
  shipmentId  String
  orderItemId String
  qty         Int    @default(1)

  shipment Shipment @relation("ShipmentToAlloc", fields: [shipmentId], references: [id], onDelete: Cascade, map: "fk_shipment_allocations__shipment")

  orderItem OrderItem @relation("OrderItemToAlloc", fields: [orderItemId], references: [id], onDelete: Cascade, map: "fk_shipment_allocations__order_item")

  @@unique([shipmentId, orderItemId], name: "uq_shipment_allocations__shipment_order_item")
  @@index([orderItemId], name: "ix_shipment_allocations__order_item")
  @@index([shipmentId], name: "ix_shipment_allocations__shipment")
  @@map("shipment_allocations")
}

model Return {
  id                     String       @id @default(cuid())
  orderId                String
  orderItemId            String? // íŠ¹ì • ìƒí’ˆ ë°˜í’ˆ/êµí™˜ ì‹œ
  type                   ReturnType   @default(RETURN) // RETURN, EXCHANGE, CANCEL
  reason                 String // ë°˜í’ˆ ì‚¬ìœ 
  status                 ReturnStatus @default(PENDING)
  refundAmount           Decimal?     @db.Decimal(12, 2)
  notes                  String? // ê³ ê° ë©”ëª¨
  adminNotes             String? // ê´€ë¦¬ì ë©”ëª¨
  processedBy            String? // ì²˜ë¦¬ì ID
  processedAt            DateTime? // ì²˜ë¦¬ ì¼ì‹œ
  refundId               String? // PGì‚¬ í™˜ë¶ˆ ID
  trackingNumber         String? // ë°˜í’ˆ íšŒìˆ˜ ì†¡ì¥ë²ˆí˜¸
  carrier                String? // ë°˜í’ˆ íšŒìˆ˜ íƒë°°ì‚¬
  exchangeTrackingNumber String? // êµí™˜ ìƒí’ˆ ì†¡ì¥ë²ˆí˜¸
  exchangeCarrier        String? // êµí™˜ ìƒí’ˆ íƒë°°ì‚¬
  metadata               Json? // ì¶”ê°€ ë©”íƒ€ë°ì´í„°
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt

  // Relations
  order     Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderItem OrderItem? @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  refunds   Refund[] // í™˜ë¶ˆ ë‚´ì—­

  @@map("returns")
}

// í™˜ë¶ˆ ì‚¬ìœ  ë¶„ë¥˜
enum RefundReason {
  PRODUCT_DEFECT // ìƒí’ˆ ë¶ˆëŸ‰
  CUSTOMER_CHANGE // êµ¬ë§¤ì ë³€ì‹¬
  DELIVERY_ERROR // ë°°ì†¡ ì˜¤ë¥˜
  WRONG_ITEM // ì˜ëª»ëœ ìƒí’ˆ ë°°ì†¡
  DAMAGED_PACKAGE // í¬ì¥ ì†ìƒ
  SIZE_MISMATCH // ì‚¬ì´ì¦ˆ ë¶ˆì¼ì¹˜
  COLOR_MISMATCH // ìƒ‰ìƒ ë¶ˆì¼ì¹˜
  OTHER // ê¸°íƒ€
}

// í™˜ë¶ˆ ìƒíƒœ
enum RefundStatus {
  PENDING // í™˜ë¶ˆ ëŒ€ê¸°
  PROCESSING // í™˜ë¶ˆ ì²˜ë¦¬ ì¤‘
  COMPLETED // í™˜ë¶ˆ ì™„ë£Œ
  FAILED // í™˜ë¶ˆ ì‹¤íŒ¨
  CANCELLED // í™˜ë¶ˆ ì·¨ì†Œ
}

// í™˜ë¶ˆ ë‚´ì—­
model Refund {
  id             String       @id @default(cuid())
  returnId       String? // ë°˜í’ˆ ìš”ì²­ì´ ìˆëŠ” ê²½ìš° (ì§ì ‘ ì·¨ì†ŒëŠ” null)
  orderId        String
  orderItemId    String? // íŠ¹ì • ìƒí’ˆ í™˜ë¶ˆ ì‹œ
  paymentKey     String // í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ í‚¤
  refundAmount   Decimal      @db.Decimal(12, 2) // í™˜ë¶ˆ ê¸ˆì•¡
  refundReason   RefundReason // í™˜ë¶ˆ ì‚¬ìœ 
  status         RefundStatus @default(PENDING) // í™˜ë¶ˆ ìƒíƒœ
  tossRefundId   String? // í† ìŠ¤í˜ì´ë¨¼ì¸  í™˜ë¶ˆ ID
  transactionKey String? // í† ìŠ¤í˜ì´ë¨¼ì¸  ê±°ë˜ í‚¤
  receiptKey     String? // í† ìŠ¤í˜ì´ë¨¼ì¸  ì˜ìˆ˜ì¦ í‚¤
  refundedAt     DateTime? // í™˜ë¶ˆ ì™„ë£Œ ì¼ì‹œ
  processedBy    String? // ì²˜ë¦¬ì ID
  notes          String? // ì²˜ë¦¬ ë©”ëª¨
  metadata       Json? // ì¶”ê°€ ë©”íƒ€ë°ì´í„° (í† ìŠ¤í˜ì´ë¨¼ì¸  ì‘ë‹µ ë“±)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  return    Return?    @relation(fields: [returnId], references: [id], onDelete: Cascade)
  order     Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderItem OrderItem? @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@map("refunds")
}

model Review {
  id          String   @id @default(cuid())
  productId   String
  userId      String
  orderId     String // ì£¼ë¬¸ ID ì¶”ê°€
  orderItemId String // ì£¼ë¬¸ ìƒí’ˆ ID ì¶”ê°€
  rating      Int
  title       String?
  content     String
  isVerified  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@unique([orderId, orderItemId]) // ì£¼ë¬¸ë³„ ì£¼ë¬¸ìƒí’ˆë³„ë¡œ í•œ ë²ˆë§Œ ë¦¬ë·° ì‘ì„± ê°€ëŠ¥
  @@map("reviews")
}

model Qna {
  id        String   @id @default(cuid())
  productId String?
  userId    String
  question  String
  answer    String?
  isPublic  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("qnas")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  orderId    String?
  paymentId  String?
  action     String
  resource   String
  resourceId String?
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  order   Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  payment Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

// Enums
enum UserRole {
  BIZ
  CONSUMER
  ADMIN
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum PointsType {
  EARN
  SPEND
  EXPIRE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethod {
  KAKAO_PAY
  NAVER_PAY
  CREDIT_CARD
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
  PARTIALLY_CANCELLED
}

enum ShipmentStatus {
  PENDING
  SHIPPED
  IN_TRANSIT
  DELIVERED
  FAILED
}

enum ReturnType {
  RETURN // ë°˜í’ˆ
  EXCHANGE // êµí™˜
  CANCEL // ì·¨ì†Œ
}

enum ReturnStatus {
  PENDING // ìš”ì²­ ì ‘ìˆ˜
  APPROVED // ìŠ¹ì¸
  PROCESSING // ì²˜ë¦¬ì¤‘
  COMPLETED // ì™„ë£Œ
  REJECTED // ê±°ì ˆ
}

// ===== User Address =====
model UserAddress {
  id                   String   @id @default(cuid())
  userId               String
  name                 String // ë°°ì†¡ì§€ ë³„ì¹­ (ì˜ˆ: 'ì§‘', 'íšŒì‚¬')
  receiverName         String // ìˆ˜ë ¹ì¸ ì´ë¦„
  receiverPhoneNumber1 String // ìˆ˜ë ¹ì¸ ì „í™”ë²ˆí˜¸ 1
  receiverPhoneNumber2 String? // ìˆ˜ë ¹ì¸ ì „í™”ë²ˆí˜¸ 2 (ì„ íƒ)
  zoneNumber           String // ìš°í¸ë²ˆí˜¸ (ìƒˆ 5ìë¦¬)
  baseAddress          String // ê¸°ë³¸ ì£¼ì†Œ (ë„ë¡œëª… ì£¼ì†Œ)
  detailAddress        String // ìƒì„¸ ì£¼ì†Œ
  isDefault            Boolean  @default(false) // ê¸°ë³¸ ë°°ì†¡ì§€ ì—¬ë¶€
  isActive             Boolean  @default(true) // í™œì„±í™” ì—¬ë¶€
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isDefault])
  @@map("user_addresses")
}
